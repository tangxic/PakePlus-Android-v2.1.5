<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroSpark</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â³</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        [x-cloak] { display: none !important; }
        .active-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .font-mono-nums { font-variant-numeric: tabular-nums; }
        .progress-bar { transition: width 1s linear; }
        
        .nav-item { transition: color 0.2s; position: relative; }
        .nav-item.active { color: #0d9488; }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: #0d9488; border-radius: 50%;
        }
        
        .focus-bg-gradient { background: #0d9488; } 
        .text-gold { color: #fcd34d; }
        .checkbox-anim { transition: all 0.2s ease; }
        .checkbox-anim:checked { background-color: #6366f1; border-color: #6366f1; }

        .slide-up-enter { transform: translateY(100%); }
        .slide-up-enter-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(0); }
        .slide-up-leave { transform: translateY(0); }
        .slide-up-leave-active { transition: transform 0.2s ease-in; transform: translateY(100%); }
        
        .animate-scale-up { animation: scaleUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .ai-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .typing-cursor::after { content: '|'; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neuro: '#0d9488', 
                        'neuro-light': '#ccfbf1',
                        'neuro-dark': '#0f766e',
                        surface: '#ffffff',
                        background: '#f4f6f8',
                        todo: '#6366f1',
                        danger: '#e89da2',
                        ai: '#8b5cf6',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-900 h-[100dvh] w-screen overflow-hidden flex justify-center items-center"
      x-data="flowApp()" x-init="initApp()">

    <div class="w-full h-full md:h-[95vh] md:max-w-md bg-background relative shadow-2xl md:rounded-[2.5rem] overflow-hidden flex flex-col">

        <div x-show="view === 'dashboard'" class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <div class="pt-10 pb-4 px-6 bg-surface z-20 shadow-sm flex justify-between items-center sticky top-0 shrink-0">
                <div class="flex items-center gap-4">
                    <button @click="showSettings = true" class="text-gray-400 hover:text-gray-600 active-press">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </button>
                    <button @click="showGuide = true" class="text-gray-400 hover:text-neuro active-press">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    </button>
                </div>
                
                <div class="absolute left-1/2 transform -translate-x-1/2 flex items-center gap-2" x-show="activeTab === 'list'">
                    <svg class="w-6 h-6 text-neuro" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 22h14"/>
                        <path d="M5 2h14"/>
                        <path d="M17 22v-4.172a2 2 0 0 0-.586-1.414L12 12l-4.414 4.414A2 2 0 0 0 7 17.828V22"/>
                        <path d="M7 2v4.172a2 2 0 0 0 .586 1.414L12 12l4.414-4.414A2 2 0 0 0 17 6.172V2"/>
                    </svg>
                    <h1 class="text-xl font-bold tracking-tight text-gray-800">NeuroSpark</h1>
                </div>
                <div class="absolute left-1/2 transform -translate-x-1/2" x-show="activeTab === 'todo'">
                    <h1 class="text-xl font-bold tracking-tight text-gray-800">Inbox</h1>
                </div>
                
                <button @click="openAIModal()" class="flex items-center gap-1 bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg shadow-indigo-200 active-press">
                    <span>âœ¨ AI åˆ†è§£</span>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto no-scrollbar relative pb-28">
                <div x-show="activeTab === 'list'" x-transition:enter="transition ease-out duration-200" class="p-4 space-y-3">
                    <template x-for="(routine, index) in routines" :key="routine.id">
                        <div class="bg-surface p-3 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between gap-3 active-press transition-all hover:border-neuro group">
                            <div @click="openRoutine(index)" class="flex-1 flex items-center gap-3 min-w-0 cursor-pointer">
                                <div class="w-12 h-12 rounded-xl bg-teal-50 text-2xl flex items-center justify-center shadow-inner shrink-0" x-text="routine.emoji"></div>
                                <div class="min-w-0 flex-1">
                                    <div class="flex justify-between items-baseline pr-2">
                                        <h3 class="font-bold text-base text-gray-800 leading-tight truncate" x-text="routine.title"></h3>
                                    </div>
                                    <div class="text-[10px] text-gray-400 mt-1 flex items-center gap-1.5">
                                        <span x-text="routine.steps.length + ' steps'"></span>
                                        <span class="w-0.5 h-0.5 bg-gray-300 rounded-full"></span>
                                        <span x-text="calculateTotalTime(routine) + ' min'"></span>
                                    </div>
                                    <div class="flex gap-0.5 mt-1.5 opacity-20 h-0.5 w-20">
                                        <template x-for="i in Math.min(routine.steps.length, 10)">
                                            <div class="flex-1 bg-gray-800 rounded-full"></div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <button @click.stop="deleteRoutine(index)" class="w-9 h-9 flex items-center justify-center text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors shrink-0 active:scale-90">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </template>
                    <div x-show="routines.length === 0" class="text-center py-10 text-gray-400 text-sm">ç‚¹å‡»å³ä¸Šè§’ AIï¼Œç‚¹ç‡ƒä½ çš„ç¬¬ä¸€ä¸ªç«èŠ±</div>
                </div>

                <div x-show="activeTab === 'todo'" x-cloak x-transition:enter="transition ease-out duration-200" class="p-5 pb-32">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800">Inbox</h3>
                        <button @click="clearCompletedTodos()" class="text-xs text-gray-400 bg-gray-100 px-3 py-1.5 rounded-full font-bold">æ¸…é™¤å®Œæˆ</button>
                    </div>
                    <div class="space-y-1">
                        <template x-for="(todo, index) in uncompletedTodos" :key="todo.id">
                            <div class="flex items-center gap-3 py-3 px-1 border-b border-gray-50 bg-white">
                                <input type="checkbox" @change="toggleTodo(todo.id)" class="w-5 h-5 rounded border-2 border-gray-300 text-todo focus:ring-todo checkbox-anim cursor-pointer">
                                <input x-model="todo.text" @blur="saveTodos()" class="flex-1 bg-transparent border-none outline-none text-gray-800 font-medium text-base placeholder-gray-400" placeholder="æ·»åŠ å¾…åŠ...">
                                <button @click="decomposeTodoWithAI(todo)" class="text-indigo-400 hover:text-indigo-600 p-1"><span class="text-xs">âœ¨</span></button>
                            </div>
                        </template>
                    </div>
                    <div class="mt-8" x-show="completedTodos.length > 0">
                        <div class="flex items-center gap-2 mb-2 px-1 cursor-pointer select-none" @click="showCompletedTodos = !showCompletedTodos">
                            <span class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">å·²å®Œæˆ <span x-text="completedTodos.length"></span></span>
                        </div>
                        <div x-show="showCompletedTodos" x-collapse class="space-y-1 opacity-60">
                            <template x-for="todo in completedTodos" :key="todo.id">
                                <div class="flex items-center gap-3 py-3 px-1 border-b border-gray-50">
                                    <input type="checkbox" checked @change="toggleTodo(todo.id)" class="w-5 h-5 rounded border-2 border-gray-300">
                                    <span class="flex-1 text-gray-500 line-through" x-text="todo.text"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full bg-surface border-t border-gray-100 h-20 px-6 flex justify-between items-center z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
                <button @click="activeTab = 'list'" class="nav-item flex flex-col items-center gap-1 w-16" :class="activeTab === 'list' ? 'active' : 'text-gray-400'">
                    <span class="text-2xl">âš¡</span>
                    <span class="text-[10px] font-bold">Routines</span>
                </button>
                <button @click="handleAddButton()" 
                        class="w-14 h-14 rounded-full text-white text-3xl shadow-xl flex items-center justify-center active-press -mt-8 border-[4px] border-surface relative z-50 pb-1 transition-colors"
                        :class="activeTab === 'list' ? 'bg-neuro shadow-teal-200/50' : 'bg-todo shadow-indigo-200/50'">
                    +
                </button>
                <button @click="activeTab = 'todo'" class="nav-item flex flex-col items-center gap-1 w-16" :class="activeTab === 'todo' ? 'active text-todo' : 'text-gray-400'">
                    <span class="text-2xl">ğŸ“</span>
                    <span class="text-[10px] font-bold">Tasks</span>
                </button>
            </div>

            <div x-show="showNewRoutineForm" x-cloak class="absolute inset-0 bg-black/40 z-[60] flex items-center justify-center p-6 backdrop-blur-sm" @click.self="showNewRoutineForm = false">
                <div class="bg-surface w-full max-w-[90%] rounded-3xl p-6 shadow-2xl animate-scale-up">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">æ–°å»ºä¸“æ³¨åœºæ™¯</h3>
                    <div class="flex gap-2 mb-4">
                        <button @click="$dispatch('open-emoji-picker', { target: 'newRoutineEmoji' })" 
                                class="w-14 h-14 bg-gray-50 rounded-xl text-3xl flex items-center justify-center border border-gray-200 shrink-0"
                                x-text="newRoutineEmoji">
                        </button>
                        <input x-model="newRoutineTitle" type="text" placeholder="åœºæ™¯åç§°..." class="flex-1 min-w-0 bg-background px-4 rounded-xl outline-none focus:ring-2 ring-neuro text-gray-800">
                    </div>
                    <div class="flex gap-3">
                        <button @click="showNewRoutineForm = false" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                        <button @click="createNewRoutine(); showNewRoutineForm = false" class="flex-1 bg-neuro text-white py-3 rounded-xl font-bold shadow-md">åˆ›å»º</button>
                    </div>
                </div>
            </div>

            <div x-show="showGuide" x-cloak class="absolute inset-0 bg-black/50 z-[90] flex items-center justify-center p-6 backdrop-blur-sm" @click.self="showGuide = false">
                <div class="bg-surface w-full max-w-[90%] h-[80%] rounded-[2rem] p-6 shadow-2xl animate-scale-up flex flex-col overflow-hidden">
                    <div class="flex justify-between items-center mb-4 shrink-0">
                        <h3 class="font-black text-2xl text-gray-800">ğŸ§  ä½œæˆ˜æ‰‹å†Œ</h3>
                        <button @click="showGuide = false" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center">âœ•</button>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar space-y-6 pr-2">
                        <div class="bg-indigo-50 p-5 rounded-2xl border border-indigo-100">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">ğŸ›¡ï¸</span>
                                <h4 class="font-bold text-indigo-900">åè®®ä¸€ï¼šå¤–åŒ…å†³ç­–</h4>
                            </div>
                            <p class="text-sm text-indigo-800 leading-relaxed opacity-80">
                                é‡åˆ°â€œä¸æƒ³åŠ¨â€çš„å›°éš¾ä»»åŠ¡ï¼ˆå¦‚å†™è®ºæ–‡ï¼‰ï¼Œ<b>ç»å¯¹ä¸è¦è‡ªå·±å»ºæ¸…å•</b>ã€‚ç‚¹å‡»å³ä¸Šè§’ <span class="font-bold">âœ¨AI åˆ†è§£</span>ï¼Œè®©â€œèµ›åšæ•™å®˜â€æ›¿ä½ å‘å·æ–½ä»¤ã€‚ä½ åªæ˜¯ä¸€ä¸ªæ— æƒ…çš„æ‰§è¡Œæœºå™¨ã€‚
                            </p>
                        </div>
                        <div class="bg-teal-50 p-5 rounded-2xl border border-teal-100">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">ğŸŒŠ</span>
                                <h4 class="font-bold text-teal-900">åè®®äºŒï¼šæµä½“åŠ¨åŠ›å­¦</h4>
                            </div>
                            <p class="text-sm text-teal-800 leading-relaxed opacity-80">
                                å®Œç¾ä¸»ä¹‰æ˜¯é™·é˜±ã€‚ç›¯ç€æ­¥éª¤è¶…è¿‡ 1 åˆ†é’Ÿæ²¡åŠ¨ï¼Ÿç«‹å³ç‚¹å³ä¸‹è§’ <span class="font-bold">SKIP</span>ã€‚è·³è¿‡ä¸æ˜¯é€ƒå…µï¼Œæ˜¯æˆ˜æœ¯è§„é¿ã€‚ä¿æŒè¿›åº¦çš„æµåŠ¨æ¯”æ­»ç£•æ›´é‡è¦ã€‚
                            </p>
                        </div>
                        <div class="bg-orange-50 p-5 rounded-2xl border border-orange-100">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">ğŸ†˜</span>
                                <h4 class="font-bold text-orange-900">åè®®ä¸‰ï¼šç³»ç»Ÿé‡å¯</h4>
                            </div>
                            <p class="text-sm text-orange-800 leading-relaxed opacity-80">
                                å¤§è„‘æ­»æœº/åƒµä½æ—¶ï¼Œç‚¹ä¸“æ³¨é¡µå·¦ä¾§çš„ <span class="font-bold">ğŸ†˜ æ•‘å‘½</span>ã€‚æ‰§è¡Œé‚£ä¸ªçœ‹èµ·æ¥å¾ˆè ¢çš„ç‰©ç†åŠ¨ä½œï¼ˆå¦‚æ·±è¹²ï¼‰ï¼Œè¿™æ˜¯å¼ºåˆ¶é‡å¯å‰é¢å¶çš„å”¯ä¸€å¼€å…³ã€‚
                            </p>
                        </div>
                        <div class="bg-purple-50 p-5 rounded-2xl border border-purple-100">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">ğŸ§</span>
                                <h4 class="font-bold text-purple-900">åè®®å››ï¼šæ„Ÿå®˜å±è”½</h4>
                            </div>
                            <p class="text-sm text-purple-800 leading-relaxed opacity-80">
                                æ¯ç‡¥ä»»åŠ¡é€‰ <b>å’–å•¡é¦†/å›¾ä¹¦é¦†</b> (Body Doubling)ã€‚<br>
                                æåº¦ä¸“æ³¨é€‰ <b>ä¸‹é›¨/ç²‰å™ª</b> (ç‰©ç†å±è”½)ã€‚<br>
                                å»ºç«‹åå°„ï¼šæˆ´ä¸Šè€³æœº = å¼€å·¥ã€‚
                            </p>
                        </div>
                        <div class="text-center text-xs text-gray-400 pt-4 italic">
                            â€œNeuroSpark: ä½ å¤§è„‘çš„å¤–ç½®é©±åŠ¨ç¨‹åºã€‚â€
                        </div>
                    </div>
                </div>
            </div>

            <div x-show="showSettings" x-cloak class="absolute inset-0 bg-black/40 z-[80] flex items-center justify-center p-6 backdrop-blur-sm" @click.self="showSettings = false">
                <div class="bg-surface w-full max-w-[90%] rounded-3xl p-6 shadow-2xl animate-scale-up">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">âš™ï¸ AI è®¾ç½®</h3>
                    <div class="space-y-3 mb-6">
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">Base URL</label>
                            <input x-model="aiSettings.baseUrl" type="text" class="w-full bg-background px-3 py-2 rounded-lg text-sm border-none outline-none focus:ring-1 ring-neuro mt-1" placeholder="é»˜è®¤: https://api.siliconflow.cn/v1">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">API Key</label>
                            <input x-model="aiSettings.apiKey" type="password" class="w-full bg-background px-3 py-2 rounded-lg text-sm border-none outline-none focus:ring-1 ring-neuro mt-1" placeholder="sk-...">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 uppercase">Model Name</label>
                            <input x-model="aiSettings.model" type="text" class="w-full bg-background px-3 py-2 rounded-lg text-sm border-none outline-none focus:ring-1 ring-neuro mt-1" placeholder="é»˜è®¤: Qwen/Qwen2.5-7B-Instruct">
                        </div>
                        <div class="text-[10px] text-gray-400 leading-tight">
                            é»˜è®¤ä½¿ç”¨ç¡…åŸºæµåŠ¨ API (Qwen2.5) ä»¥è·å¾—æœ€ä½³é€Ÿåº¦å’Œå…¼å®¹æ€§ã€‚è¯·å¡«å…¥å¯¹åº”çš„ Keyã€‚
                        </div>
                    </div>
                    <button @click="saveAISettings(); showSettings = false" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold shadow-md">ä¿å­˜é…ç½®</button>
                </div>
            </div>

            <div x-show="showAIModalState" x-cloak class="absolute inset-0 bg-black/60 z-[70] flex items-center justify-center p-6 backdrop-blur-md" @click.self="!aiIsLoading ? showAIModalState = false : null">
                <div class="bg-gray-900 w-full max-w-[90%] rounded-3xl p-6 shadow-2xl animate-scale-up border border-gray-700 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-purple-500/20 rounded-full blur-2xl -mr-10 -mt-10"></div>
                    <div class="absolute bottom-0 left-0 w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl -ml-10 -mb-10"></div>
                    
                    <div class="relative z-10 text-white">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="font-bold text-xl">å¤–ç½®å¤§è„‘è¿æ¥ä¸­...</h3>
                                <p class="text-gray-400 text-xs mt-1" x-text="aiSettings.apiKey ? 'Connecting to: ' + aiSettings.model : 'Demo Mode'"></p>
                            </div>
                            <button @click="showAIModalState = false" class="text-gray-500 hover:text-white" x-show="!aiIsLoading">âœ•</button>
                        </div>
                        <div x-show="!aiIsLoading">
                            <div class="bg-gray-800 rounded-xl p-4 mb-4 border border-gray-700">
                                <label class="text-gray-500 text-xs font-bold uppercase block mb-2">ä»»åŠ¡æŒ‡ä»¤è¾“å…¥</label>
                                <textarea x-model="aiPrompt" rows="2" class="w-full bg-transparent border-none outline-none text-white placeholder-gray-600 resize-none text-lg" placeholder="ä¾‹å¦‚ï¼šå†™è®ºæ–‡ã€æ”¶æ‹¾çŒªçªã€ä¸æƒ³åŠ¨..."></textarea>
                            </div>
                            <button @click="runAIGeneration()" :disabled="!aiPrompt.trim()" class="w-full ai-gradient text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/30 active:scale-95 transition-transform flex items-center justify-center gap-2 disabled:opacity-50 disabled:scale-100">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> å¯åŠ¨æ‰§è¡Œå¼•æ“
                            </button>
                        </div>
                        <div x-show="aiIsLoading" class="py-8 text-center">
                            <div class="w-16 h-16 rounded-full border-4 border-indigo-500/30 border-t-indigo-500 animate-spin mx-auto mb-6"></div>
                            <div class="text-indigo-300 font-bold text-lg mb-2" x-text="aiPersona ? aiPersona + ' æ­£åœ¨éƒ¨ç½²æˆ˜æœ¯...' : 'æ­£åœ¨éƒ¨ç½²æˆ˜æœ¯...'"></div>
                            <div class="text-gray-500 text-sm h-6 typing-cursor" x-text="aiLoadingText"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="view === 'detail'" x-cloak class="flex-1 flex flex-col h-full bg-surface z-40 absolute inset-0">
            <div class="pt-10 pb-2 px-4 flex items-center justify-between sticky top-0 bg-surface/95 backdrop-blur z-30 border-b border-gray-50">
                <button @click="view = 'dashboard'" class="text-gray-500 flex items-center gap-1 font-bold text-sm bg-gray-50 px-3 py-1.5 rounded-full">â† Back</button>
                <div class="flex flex-col items-center cursor-pointer active-press" @click="renameRoutine()">
                    <h2 class="font-bold text-lg text-gray-800 truncate max-w-[150px]" x-text="currentRoutine?.title"></h2>
                </div>
                <button @click="toggleEdit()" class="text-neuro font-bold text-sm px-2" x-text="isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'"></button>
            </div>
            
            <div class="px-5 py-3">
                 <div class="bg-indigo-50/50 rounded-2xl p-4 border border-indigo-100">
                     <div class="flex items-center justify-between mb-3">
                         <div class="flex items-center gap-2 text-indigo-900 font-bold text-sm"><span class="animate-pulse">ğŸ§</span> æ°›å›´éŸ³æ•ˆ</div>
                         <span class="text-xs text-indigo-400 font-mono" x-text="selectedNoiseType || 'é™éŸ³'"></span>
                     </div>
                     <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                         <template x-for="noise in noiseOptions" :key="noise.type">
                             <button @click="selectNoise(noise.type)" class="px-3 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border" :class="selectedNoiseType === noise.type ? 'bg-indigo-500 text-white border-indigo-500 shadow-md' : 'bg-white text-gray-500 border-gray-200'"><span x-text="noise.icon"></span> <span x-text="noise.name"></span></button>
                         </template>
                         <button @click="triggerFileUpload()" class="px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border" :class="selectedNoiseType === 'custom' ? 'bg-indigo-500 text-white border-indigo-500 shadow-md' : 'bg-white text-gray-500 border-gray-200'">ğŸ“‚ è‡ªé€‰ <span x-show="hasCustomAudio" class="text-[10px] ml-1 opacity-70">(å·²å­˜)</span></button>
                         <input type="file" id="music-upload" accept="audio/*" class="hidden" @change="handleMusicUpload">
                     </div>
                 </div>
             </div>

            <div class="flex-1 overflow-y-auto no-scrollbar px-5 pb-32 space-y-3 pt-2">
                <div x-show="currentRoutine?.isAI" class="text-xs font-bold text-indigo-400 uppercase tracking-widest text-center mb-2">âœ¨ NeuroSpark Mission</div>
                <template x-for="(step, index) in currentRoutine?.steps" :key="step.id">
                    <div class="flex items-center gap-4 py-3 border-b border-gray-50 last:border-0 group">
                        <div class="w-10 h-10 rounded-full bg-white border-2 border-gray-100 flex-shrink-0 flex items-center justify-center text-lg shadow-sm shrink-0" x-text="step.emoji"></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800 truncate text-base" x-text="step.text"></div>
                            <div class="text-xs text-gray-400" x-text="step.duration + ' min'"></div>
                        </div>
                        <button x-show="isEditing" @click="removeStep(index)" class="text-red-500 text-xs font-bold bg-red-50 px-3 py-1 rounded-full shrink-0">åˆ é™¤</button>
                    </div>
                </template>
                <div x-show="isEditing" class="mt-4 p-4 bg-gray-50 rounded-[2rem] border border-gray-200">
                    <div class="flex gap-2 mb-3">
                        <button @click="$dispatch('open-emoji-picker', { target: 'newStepEmoji' })" class="w-14 h-14 bg-white rounded-2xl text-2xl flex items-center justify-center border border-gray-200 shadow-sm shrink-0" x-text="newStepEmoji"></button>
                        <input x-model="newStepText" placeholder="æ–°æ­¥éª¤åç§°" class="flex-1 min-w-0 px-5 py-3 rounded-2xl border-none outline-none focus:ring-2 ring-neuro text-sm shadow-sm">
                    </div>
                    <div class="flex gap-2 items-center">
                        <input x-model="newStepDuration" type="number" placeholder="min" class="w-24 px-5 py-3 rounded-2xl border-none outline-none text-sm shadow-sm">
                        <button @click="addStep()" class="flex-1 bg-neuro text-white py-3 rounded-2xl text-base font-bold shadow-md active-press flex items-center justify-center gap-2"><span>+ æ·»åŠ </span></button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-white via-white to-transparent z-30">
                <button @click="startFlow()" class="w-full bg-neuro hover:bg-neuro-dark text-white text-xl font-bold py-5 rounded-[1.5rem] shadow-xl shadow-teal-200/50 active-press transition-all">ğŸš€ å¼€å§‹ä¸“æ³¨</button>
            </div>
        </div>

        <div x-show="view === 'focus'" x-cloak class="flex-1 flex flex-col h-full absolute inset-0 bg-surface z-50 overflow-hidden">
            <div class="shrink-0 pt-8 px-4 pb-2 bg-neuro-light/30 rounded-b-[2rem] mb-2">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar py-1 px-1 flex-1">
                        <template x-for="(step, index) in currentRoutine?.steps" :key="step.id">
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-all duration-300 shrink-0 border"
                                 :class="index <= currentStepIndex ? 'bg-neuro border-neuro' : 'bg-gray-100 border-gray-200'">
                                <svg x-show="index < currentStepIndex" class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                <div x-show="index >= currentStepIndex" class="w-3 h-3 rounded-full" :class="index === currentStepIndex ? 'bg-white' : 'bg-gray-300'"></div>
                            </div>
                        </template>
                    </div>
                    <button @click="handleExitRequest()" class="ml-2 w-8 h-8 flex items-center justify-center text-gray-400 hover:text-gray-600 active-press">âœ•</button>
                </div>
                <div class="flex justify-between items-end px-1 pb-2 h-10">
                    <div x-show="currentStepIndex > 0" x-transition.opacity>
                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-0.5">Previous Step</div>
                        <div class="font-bold text-sm text-gray-700 truncate max-w-[180px]" x-text="getPrevStepText()"></div>
                    </div>
                    <button x-show="currentStepIndex > 0" @click="previousStep()" class="text-xs font-bold text-gray-500 bg-white px-3 py-1.5 rounded-full shadow-sm border border-gray-100 active-press">
                        Back to previous
                    </button>
                </div>
            </div>

            <div class="flex-1 flex flex-col px-6 pb-4 min-h-0 relative">
                <div class="w-full rounded-[2rem] p-5 text-white shadow-2xl shadow-teal-200/50 flex flex-col relative overflow-hidden flex-1 min-h-0 transition-all duration-1000"
                     :style="getDynamicBackground()"
                     :class="isPaused ? 'opacity-80 saturate-50 scale-[0.98]' : ''">
                    <div class="flex justify-between items-start z-10 mb-2 shrink-0">
                        <span class="text-white font-medium text-sm"><span x-text="currentStep?.duration"></span> min</span>
                        <div class="bg-white/20 p-2 rounded-xl backdrop-blur-md"><span class="text-2xl" x-text="currentStep?.emoji"></span></div>
                    </div>
                    <div class="z-10 shrink-0 my-auto">
                        <div class="text-[4.5rem] leading-none font-mono-nums font-bold tracking-tighter drop-shadow-sm text-gold" x-text="formatTimeVideoStyle(timeLeft)">00:00</div>
                    </div>
                    <div class="z-10 mt-2 mb-6 shrink-0 flex-1 overflow-y-auto no-scrollbar flex items-start">
                        <h2 class="text-2xl font-bold leading-snug text-white" x-text="currentStep?.text"></h2>
                    </div>
                    
                    <button @click="triggerStuck()" class="z-10 bg-white/10 hover:bg-white/20 text-white text-xs font-bold py-2 px-4 rounded-full border border-white/30 backdrop-blur self-start mb-2 active:scale-95 transition-transform shrink-0">ğŸ†˜ æˆ‘å¡ä½äº†</button>

                    <div class="w-full h-4 bg-black/20 rounded-full mt-auto z-10 shrink-0 overflow-hidden backdrop-blur-sm mb-1">
                        <div class="h-full bg-white/90 rounded-full progress-bar shadow-[0_0_10px_rgba(255,255,255,0.3)]" :style="`width: ${calculateStepProgress()}%`"></div>
                    </div>
                </div>
                <div class="shrink-0 mt-4 px-1">
                    <div class="text-gray-400 text-[10px] lowercase mb-1 font-bold">next step</div>
                    <div class="font-bold text-gray-800 text-sm truncate" x-text="getNextStepText()"></div>
                </div>
            </div>

            <div class="shrink-0 h-28 px-8 flex items-center justify-between pb-6">
                <button @click="togglePause()" class="flex flex-col items-center gap-1 text-gray-400 active-press w-16">
                    <div class="w-12 h-12 rounded-full border-2 border-gray-200 flex items-center justify-center">
                        <svg x-show="!isPaused" class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        <svg x-show="isPaused" class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    </div>
                    <span class="text-[10px] font-bold tracking-widest" x-text="isPaused ? 'RESUME' : 'PAUSE'"></span>
                </button>
                <button @click="completeStep()" class="w-20 h-20 bg-neuro rounded-full shadow-xl shadow-teal-200/50 flex items-center justify-center text-white active-press scale-110">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </button>
                <button @click="skipStep()" class="flex flex-col items-center gap-1 text-gray-400 active-press w-16">
                    <div class="w-12 h-12 rounded-full border-2 border-gray-200 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                    </div>
                    <span class="text-[10px] font-bold tracking-widest">SKIP</span>
                </button>
            </div>
            
            <div x-show="showStuckModal" x-cloak class="absolute inset-0 bg-black/60 z-[100] flex items-center justify-center p-6 backdrop-blur-sm" @click.self="showStuckModal = false">
                <div class="bg-white w-full rounded-2xl p-6 shadow-2xl animate-scale-up text-center">
                    <div class="text-4xl mb-4">ğŸš‘</div>
                    <h3 class="font-bold text-xl text-gray-800 mb-2">ç´§æ€¥æ•‘æ´è¡ŒåŠ¨</h3>
                    <p class="text-gray-500 mb-6 text-sm">å¤§è„‘æ­»æœºäº†ï¼Ÿæ²¡å…³ç³»ï¼Œæ‰§è¡Œè¿™ä¸ªå¾®è¡ŒåŠ¨é‡å¯ç³»ç»Ÿï¼š</p>
                    <div class="bg-indigo-50 p-4 rounded-xl border-2 border-indigo-100 mb-6">
                        <p class="text-indigo-900 font-bold text-lg" x-text="currentStuckAction"></p>
                    </div>
                    <button @click="showStuckModal = false" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg active-press">æ‰§è¡Œå®Œæ¯•ï¼Œå›å½’æˆ˜æ–—ï¼</button>
                </div>
            </div>

            <div x-show="showExitModal" x-cloak class="absolute inset-0 bg-black/50 z-[100] flex items-end justify-center backdrop-blur-sm" @click.self="showExitModal = false">
                <div class="bg-white w-full rounded-t-[2.5rem] p-8 pb-12 text-center" x-transition:enter="slide-up-enter-active" x-transition:leave="slide-up-leave-active">
                    <h2 class="text-4xl font-black text-gray-900 mb-8 tracking-tight">are you sure?</h2>
                    <button @click="exitFlow()" class="w-full bg-danger text-white font-bold text-lg py-4 rounded-2xl shadow-lg active-press mb-4">cancel</button>
                    <button @click="showExitModal = false" class="text-gray-400 font-bold text-sm py-2">continue</button>
                </div>
            </div>
        </div>

        <div x-show="view === 'summary'" x-cloak class="flex-1 flex flex-col items-center justify-center p-8 h-full absolute inset-0 bg-surface z-50 text-center">
            <div class="text-8xl mb-6 animate-bounce">ğŸ</div>
            <h2 class="text-3xl font-black text-gray-800 mb-2">Mission Complete!</h2>
            <div class="bg-yellow-50 p-6 rounded-2xl border-2 border-yellow-100 my-6 max-w-xs rotate-1 shadow-lg">
                <div class="text-xs text-yellow-600 font-bold uppercase tracking-wider mb-2">Loot Drop</div>
                <div class="text-gray-800 font-bold text-xl" x-text="rewardMessage"></div>
            </div>
            <button @click="resetToDashboard()" class="w-full bg-neuro text-white text-xl font-bold py-5 rounded-[1.5rem] shadow-xl active-press mt-4">Back to List</button>
        </div>

        <div x-show="showEmojiPicker" x-cloak class="absolute inset-0 bg-black/50 z-[90] flex items-end justify-center backdrop-blur-sm" @click.self="showEmojiPicker = false">
            <div class="bg-surface w-full md:w-[90%] rounded-t-[2rem] p-6 shadow-2xl animate-slide-up h-[50%] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 text-lg">Select Icon</h3>
                    <button @click="showEmojiPicker = false" class="text-gray-400 p-2">âœ•</button>
                </div>
                <div class="flex-1 overflow-y-auto grid grid-cols-5 gap-3 content-start pb-10">
                    <template x-for="emoji in emojiList" :key="emoji">
                        <button @click="selectEmoji(emoji)" class="text-2xl p-4 bg-gray-50 rounded-2xl hover:bg-teal-50 border border-gray-100"><span x-text="emoji"></span></button>
                    </template>
                </div>
            </div>
        </div>

    </div>

    <audio id="custom-player" loop></audio>

    <script>
        // MOCK AI DATA
        const AI_MOCK_DATA = { 'default': { emoji: 'âš¡', steps: [['æ·±å‘¼å¸', 'ğŸ§˜', 1], ['æ¸…ç†æ¡Œé¢', 'ğŸ§¹', 2], ['åˆ—å‡ºç¬¬ä¸€æ­¥', 'ğŸ“', 2], ['ä¸“æ³¨æ‰§è¡ŒA', 'ğŸ”¥', 10], ['å–æ°´ä¼‘æ¯', 'ğŸ¥¤', 2], ['ä¸“æ³¨æ‰§è¡ŒB', 'ğŸ”¥', 10]] } };

        // DB Setup
        const DB_NAME = 'NeuroSparkDB', STORE_NAME = 'audioStore';
        function initDB() { return new Promise((res, rej) => { const r = indexedDB.open(DB_NAME, 1); r.onerror = rej; r.onsuccess = e => res(e.target.result); r.onupgradeneeded = e => { if (!e.target.result.objectStoreNames.contains(STORE_NAME)) e.target.result.createObjectStore(STORE_NAME); }; }); }
        async function saveAudioToDB(file) { const db = await initDB(); return new Promise((res, rej) => { const r = new FileReader(); r.onload = e => { db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).put(e.target.result, 'customBGM'); res(); }; r.readAsDataURL(file); }); }
        async function getAudioFromDB() { const db = await initDB(); return new Promise(res => { const req = db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).get('customBGM'); req.onsuccess = e => res(e.target.result); req.onerror = () => res(null); }); }

        function flowApp() {
            return {
                view: 'dashboard', activeTab: 'list', showNewRoutineForm: false, showEmojiPicker: false, emojiTarget: '',
                showExitModal: false, isPaused: false, showAIModalState: false, showSettings: false, showGuide: false,
                aiPrompt: '', aiIsLoading: false, aiLoadingText: '', aiPersona: '',
                
                showStuckModal: false, currentStuckAction: '',
                stuckActions: ['ç«™èµ·æ¥åš5ä¸ªæ·±è¹²', 'å–ä¸€å¤§å£æ°´', 'é—­çœ¼æ·±å‘¼å¸10ç§’', 'æŠŠæ‰‹æœºæ‰”åˆ°åºŠä¸Š', 'ç”¨åŠ›ä¼¸ä¸ªæ‡’è…°', 'å»æ´—æŠŠè„¸'],
                rewardMessage: '', rewards: ['ğŸ« æ‘¸é±¼åˆ¸ (15åˆ†é’Ÿæ— ç½ªæ¶æ„Ÿ)', 'ğŸ¥¤ å¥¶èŒ¶å¬å”¤å¡', 'ğŸ® æ¸¸æˆå¯åŠ¨ç‰¹æƒ', 'ğŸ›Œ åˆç¡é€šè¡Œè¯', 'ğŸ¿ é›¶é£Ÿè¡¥ç»™åŒ…', 'ğŸ† "ä¸“æ³¨ç‹è€…" ç§°å·'],

                aiSettings: { apiKey: '', baseUrl: 'https://api.siliconflow.cn/v1', model: 'Qwen/Qwen2.5-7B-Instruct' },
                emojiList: ['âœ¨','ğŸ’ª','ğŸ“š','ğŸ’»','ğŸ§','â˜•','ğŸ’§','ğŸ§˜','ğŸƒ','ğŸ’¤','ğŸ“','ğŸ“…','ğŸ“Š','ğŸ“','ğŸ”¥','ğŸµ','â°','ğŸ ','â˜€ï¸','ğŸŒ™','ğŸ“','ğŸ§ ','ğŸ’¡','ğŸ”‹','ğŸ›‘','ğŸ›','ğŸ‘•','ğŸ§¹','ğŸ¥—','ğŸ’Š','ğŸš—','ğŸ’µ','ğŸ','ğŸ®','ğŸ¨','ğŸ¶','ğŸŒ²'],
                
                noiseOptions: [ {name:'é™éŸ³',icon:'ğŸ”‡',type:''}, {name:'ç™½å™ªéŸ³',icon:'ğŸ“º',type:'white'}, {name:'ä¸‹é›¨',icon:'ğŸŒ§ï¸',type:'brown'}, {name:'ç²‰çº¢',icon:'ğŸŒŠ',type:'pink'}, {name:'å’–å•¡é¦†',icon:'â˜•',type:'coffee'}, {name:'å›¾ä¹¦é¦†',icon:'ğŸ“š',type:'library'} ],
                audioContext: null, noiseSource: null, gainNode: null, selectedNoiseType: '', hasCustomAudio: false,

                editingRoutineId: null, routines: [], todos: [],
                currentRoutineIndex: 0, currentStepIndex: 0, timeLeft: 0, timer: null, isEditing: false,
                newRoutineTitle: '', newRoutineEmoji: 'âœ¨', newStepText: '', newStepEmoji: 'âœ¨', newStepDuration: 1,
                
                get uncompletedTodos() { return this.todos.filter(t => !t.completed); },
                get completedTodos() { return this.todos.filter(t => t.completed); },
                showCompletedTodos: false,

                async initApp() {
                    const d = localStorage.getItem('neurospark_data');
                    const t = localStorage.getItem('neurospark_todos');
                    const s = localStorage.getItem('neurospark_settings');
                    if (d) this.routines = JSON.parse(d); else this.routines = [{ id: 1, title: 'Deep Work', emoji: 'ğŸ“š', steps: [{ id: 101, text: 'Put away phone', emoji: 'ğŸ“´', duration: 1 }, { id: 102, text: 'Focus Task', emoji: 'ğŸ’»', duration: 25 }] }];
                    if (t) this.todos = JSON.parse(t);
                    if (s) this.aiSettings = JSON.parse(s);
                    this.$el.addEventListener('open-emoji-picker', e => { this.emojiTarget = e.detail.target; this.showEmojiPicker = true; });
                    const c = await getAudioFromDB(); if (c) { this.hasCustomAudio = true; document.getElementById('custom-player').src = c; }
                },

                saveData() { localStorage.setItem('neurospark_data', JSON.stringify(this.routines)); },
                saveTodos() { localStorage.setItem('neurospark_todos', JSON.stringify(this.todos)); },
                saveAISettings() { localStorage.setItem('neurospark_settings', JSON.stringify(this.aiSettings)); },

                addTodo() { this.todos.unshift({ id: Date.now(), text: '', completed: false }); this.saveTodos(); },
                toggleTodo(id) { const t = this.todos.find(x => x.id === id); if(t) { t.completed = !t.completed; this.saveTodos(); } },
                clearCompletedTodos() { if(confirm('Clear completed?')) { this.todos = this.todos.filter(t => !t.completed); this.saveTodos(); } },

                openAIModal() { this.aiPrompt = ''; this.showAIModalState = true; },
                decomposeTodoWithAI(todo) { this.aiPrompt = todo.text; this.showAIModalState = true; },
                async runAIGeneration() {
                    this.aiIsLoading = true; this.aiLoadingText = "æ­£åœ¨æ‰«ææƒ…ç»ªçŠ¶æ€...";
                    const personas = ['æ¸©æŸ”ç®¡å®¶', 'èµ›åšé»‘å®¢', 'é­”é¬¼æ•™å®˜']; this.aiPersona = personas[Math.floor(Math.random() * personas.length)];
                    if (!this.aiSettings.apiKey) { await this.runFakeAI(); return; }
                    try {
                        this.aiLoadingText = `${this.aiPersona} æ­£åœ¨éƒ¨ç½²ä»»åŠ¡...`;
                        const SYSTEM_PROMPT = `ä½ ç°åœ¨æ‰®æ¼”ï¼šã€${this.aiPersona}ã€‘ã€‚ç›®æ ‡ï¼šä¸ºé‡åº¦æ‹–å»¶ç—‡ç”¨æˆ·ç”Ÿæˆä¸€ä»½â€œæ— æ³•æ‹’ç»â€çš„ä»»åŠ¡æ”»ç•¥ã€‚\n\nã€å¼ºåˆ¶æ‹†è§£è§„åˆ™ã€‘ï¼š\n1. **Step 0 æƒ…ç»ªé”šç‚¹**ï¼šç¬¬ä¸€æ­¥å¿…é¡»æ˜¯"æƒ…ç»ªè°ƒèŠ‚"ï¼ˆå¦‚ï¼šæ·±å‘¼å¸ï¼‰ï¼Œæ—¶é•¿0-1åˆ†é’Ÿã€‚\n2. **Step 1 ç‰©ç†å¯åŠ¨**ï¼šå¿…é¡»æ˜¯æå…¶ç®€å•çš„ç‰©ç†åŠ¨ä½œã€‚\n3. **é¢—ç²’åº¦**ï¼šæ€»æ­¥éª¤ 6-12 æ­¥ã€‚\n4. **ç»“å°¾å½©è›‹**ï¼šæœ€åä¸€æ­¥å¿…é¡»åŒ…å«ç‰©è´¨å¥–åŠ±æ‰¿è¯ºã€‚\n5. **è¯­æ°”**ï¼šç¬¦åˆã€${this.aiPersona}ã€‘äººè®¾ã€‚\n\nè¾“å‡ºæ ¼å¼ (çº¯JSON): { "title": "...", "emoji": "...", "steps": [ { "text": "...", "emoji": "...", "duration": 1 } ] }`;
                        const res = await fetch(`${this.aiSettings.baseUrl}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.aiSettings.apiKey}` }, body: JSON.stringify({ model: this.aiSettings.model, messages: [{ role: "system", content: SYSTEM_PROMPT }, { role: "user", content: this.aiPrompt }], temperature: 0.8, max_tokens: 2000, stream: false }) });
                        if (!res.ok) throw new Error(`API Error: ${res.status}`);
                        const data = await res.json();
                        let content = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
                        this.addGeneratedRoutine(JSON.parse(content));
                    } catch (e) { alert("è¿æ¥æ–­å¼€: " + e.message + "\nåˆ‡æ¢ç¦»çº¿æ–¹æ¡ˆã€‚"); await this.runFakeAI(); }
                },
                async runFakeAI() { const steps = ['è½½å…¥åå¤‡èƒ½æº...', 'å¯åŠ¨åº”æ€¥åè®®...']; for (const t of steps) { this.aiLoadingText = t; await new Promise(r => setTimeout(r, 600)); } const mock = AI_MOCK_DATA.default; const newR = { id: Date.now(), title: this.aiPrompt || "ä¸“æ³¨æ¨¡å¼", emoji: mock.emoji, isAI: true, steps: mock.steps.map((s, i) => ({ id: Date.now()+i, text: s[0], emoji: s[1], duration: s[2] })) }; this.addGeneratedRoutine(newR); },
                addGeneratedRoutine(data) { const newR = { id: Date.now(), title: data.title || "Mission", emoji: data.emoji || 'âœ¨', isAI: true, steps: (data.steps || []).map((s, i) => ({ id: Date.now()+i, text: s.text, emoji: s.emoji || 'ğŸ”¹', duration: parseInt(s.duration)||5 })) }; this.routines.unshift(newR); this.saveData(); this.aiIsLoading = false; this.showAIModalState = false; this.currentRoutineIndex = 0; this.startFlow(); },

                deleteRoutine(i) { if(confirm('æ”¾å¼ƒè¿™ä¸ªä»»åŠ¡ï¼Ÿ')) { this.routines.splice(i, 1); this.saveData(); } },
                renameRoutine() { const n = prompt("Rename:", this.currentRoutine.title); if(n) { this.currentRoutine.title = n; this.saveData(); } },
                handleAddButton() { this.activeTab === 'list' ? this.showNewRoutineForm = true : this.addTodo(); },
                selectEmoji(e) { if(this.emojiTarget === 'newRoutineEmoji') this.newRoutineEmoji = e; if(this.emojiTarget === 'newStepEmoji') this.newStepEmoji = e; this.showEmojiPicker = false; },
                
                openRoutine(i) { this.currentRoutineIndex = i; this.view = 'detail'; this.isEditing = false; },
                createNewRoutine() { if(this.newRoutineTitle) { this.routines.push({ id: Date.now(), title: this.newRoutineTitle, emoji: this.newRoutineEmoji, steps: [] }); this.newRoutineTitle = ''; this.saveData(); } },
                addStep() { if(this.newStepText) { this.routines[this.currentRoutineIndex].steps.push({ id: Date.now(), text: this.newStepText, emoji: this.newStepEmoji, duration: parseInt(this.newStepDuration)||1 }); this.newStepText = ''; this.saveData(); } },
                removeStep(i) { this.routines[this.currentRoutineIndex].steps.splice(i, 1); this.saveData(); },

                initAudioContext() { if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); },
                selectNoise(t) { this.selectedNoiseType = t; if (this.view === 'focus') { this.stopNoise(); if (t) this.playNoise(t); } },
                async triggerFileUpload() { if (this.hasCustomAudio && this.selectedNoiseType !== 'custom') this.selectNoise('custom'); else document.getElementById('music-upload').click(); },
                async handleMusicUpload(e) { const f = e.target.files[0]; if (f) { if (f.size > 15e6) return alert("Max 15MB"); await saveAudioToDB(f); const d = await getAudioFromDB(); document.getElementById('custom-player').src = d; this.hasCustomAudio = true; this.selectNoise('custom'); } },
                playNoise(t) {
                    if (t === 'custom') { const p = document.getElementById('custom-player'); p.src ? p.play() : alert("No audio"); return; }
                    this.initAudioContext(); if (!t) return;
                    const b = this.audioContext.createBuffer(1, 2 * 44100, 44100); const o = b.getChannelData(0); let l = 0; for (let i=0; i<b.length; i++) { let w = Math.random()*2-1; if(t==='white') o[i]=w; else if(t==='coffee'||t==='library') { o[i]=(l+(0.05*w))/1.05; l=o[i]; o[i]*=4.5; } else { o[i]=(l+(0.02*w))/1.02; l=o[i]; o[i]*=3.5; } } this.noiseSource = this.audioContext.createBufferSource(); this.noiseSource.buffer = b; this.noiseSource.loop = true; this.gainNode = this.audioContext.createGain(); const f = this.audioContext.createBiquadFilter(); if(t==='brown'||t==='coffee') { f.type='lowpass'; f.frequency.value=400; } else if(t==='pink'||t==='library') { f.type='lowpass'; f.frequency.value=1000; } else f.type='allpass'; if(t!=='white') { this.noiseSource.connect(f); f.connect(this.gainNode); } else this.noiseSource.connect(this.gainNode); this.gainNode.gain.value = (t==='library')?0.02:0.05; this.gainNode.connect(this.audioContext.destination); this.noiseSource.start();
                },
                stopNoise() { if (this.noiseSource) { this.noiseSource.stop(); this.noiseSource = null; } document.getElementById('custom-player').pause(); },

                startFlow() { if(!this.currentRoutine?.steps?.length) return alert('No steps'); this.currentStepIndex = 0; this.view = 'focus'; this.isPaused = false; this.loadStepTimer(); this.playNoise(this.selectedNoiseType); },
                loadStepTimer() { clearInterval(this.timer); this.timeLeft = this.currentStep.duration * 60; this.timer = setInterval(() => { if(!this.isPaused) { if(this.timeLeft > 0) this.timeLeft--; else clearInterval(this.timer); } }, 1000); },
                togglePause() { this.isPaused = !this.isPaused; },
                completeStep() { if(this.currentStepIndex < this.currentRoutine.steps.length - 1) { this.currentStepIndex++; this.loadStepTimer(); } else { this.finishFlow(); } },
                skipStep() { this.completeStep(); },
                previousStep() { if (this.currentStepIndex > 0) { this.currentStepIndex--; this.loadStepTimer(); } },
                finishFlow() { clearInterval(this.timer); this.stopNoise(); this.rewardMessage = this.rewards[Math.floor(Math.random() * this.rewards.length)]; this.view = 'summary'; confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#0d9488', '#fcd34d'] }); },
                
                handleExitRequest() { this.showExitModal = true; },
                exitFlow() { clearInterval(this.timer); this.stopNoise(); this.showExitModal = false; this.view = 'detail'; },
                resetToDashboard() { this.view = 'dashboard'; },
                toggleEdit() { this.isEditing = !this.isEditing; },
                triggerStuck() { this.currentStuckAction = this.stuckActions[Math.floor(Math.random() * this.stuckActions.length)]; this.showStuckModal = true; },
                getDynamicBackground() { if (!this.currentStep) return 'background: #0d9488'; const t = this.currentStep.duration * 60; const p = 1 - (this.timeLeft / t); const r = 13 + (p * (124 - 13)); const g = 148 - (p * (148 - 58)); const b = 136 + (p * (237 - 136)); return `background: linear-gradient(135deg, rgb(${r},${g},${b}) 0%, #1e1b4b 100%)`; },
                
                get currentRoutine() { return this.routines[this.currentRoutineIndex]; },
                get currentStep() { return this.currentRoutine?.steps?.[this.currentStepIndex]; },
                calculateTotalTime(r) { return r?.steps?.reduce((a, c) => a + c.duration, 0) || 0; },
                formatTimeVideoStyle(s) { const m = Math.floor(s/60).toString().padStart(2,'0'); const sec = (s%60).toString().padStart(2,'0'); return `${m}:${sec}`; },
                calculateStepProgress() { if(!this.currentStep) return 0; const t = this.currentStep.duration * 60; return ((t - this.timeLeft) / t) * 100; },
                getNextStepText() { return this.currentRoutine?.steps?.[this.currentStepIndex + 1]?.text || 'All Done!'; },
                getPrevStepText() { return this.currentRoutine?.steps?.[this.currentStepIndex - 1]?.text || ''; }
            }
        }
    </script>
</body>
</html>