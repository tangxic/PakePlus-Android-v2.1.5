<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlowFocus V6 - Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        [x-cloak] { display: none !important; }
        .active-press:active { transform: scale(0.96); transition: transform 0.1s; }
        .font-mono-nums { font-variant-numeric: tabular-nums; }
        .progress-bar { transition: width 1s linear; }
        
        /* åº•éƒ¨å¯¼èˆªæ é€‰ä¸­æ€åŠ¨ç”» */
        .nav-item { transition: color 0.2s; position: relative; }
        .nav-item.active { color: #0d9488; }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: #0d9488; border-radius: 50%;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neuro: '#0d9488', 
                        'neuro-dark': '#0f766e',
                        surface: '#ffffff',
                        background: '#f4f6f8',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 text-gray-900 h-[100dvh] w-screen overflow-hidden flex justify-center items-center"
      x-data="flowApp()" x-init="initApp()">

    <div class="w-full h-full md:h-[95vh] md:max-w-md bg-background relative shadow-2xl md:rounded-[2.5rem] overflow-hidden flex flex-col">

        <div x-show="view === 'dashboard'" class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <div class="pt-10 pb-4 px-6 bg-surface z-20 shadow-sm flex justify-between items-center sticky top-0">
                <div class="flex items-center gap-2 text-neuro">
                    <svg class="w-6 h-6 transform rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                    <h1 class="text-xl font-bold tracking-tight text-gray-800" x-text="activeTab === 'list' ? 'FlowFocus' : 'Profile'"></h1>
                </div>
                <button x-show="activeTab === 'you'" @click="clearHistory()" class="text-xs text-red-400 bg-red-50 px-2 py-1 rounded-lg">æ¸…ç©ºå†å²</button>
            </div>

            <div class="flex-1 overflow-y-auto no-scrollbar relative pb-24">
                
                <div x-show="activeTab === 'list'" x-transition:enter="transition ease-out duration-200" class="p-5 space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">My Routines</span>
                    </div>

                    <template x-for="(routine, index) in routines" :key="routine.id">
                        <div @click="openRoutine(index)" 
                             class="bg-surface p-5 rounded-3xl shadow-sm border border-gray-100 active-press cursor-pointer relative group hover:border-neuro transition-all">
                            
                            <div class="flex gap-1 mb-3 opacity-20">
                                <template x-for="i in routine.steps.length">
                                    <div class="h-1 flex-1 bg-gray-800 rounded-full"></div>
                                </template>
                            </div>

                            <div class="flex justify-between items-center">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 rounded-2xl bg-teal-50 text-3xl flex items-center justify-center shadow-inner" x-text="routine.emoji"></div>
                                    <div>
                                        <h3 class="font-bold text-lg text-gray-800 leading-tight" x-text="routine.title"></h3>
                                        <div class="text-xs text-gray-400 mt-1"><span x-text="routine.steps.length"></span> steps â€¢ <span x-text="calculateTotalTime(routine)"></span> min</div>
                                    </div>
                                </div>
                                <div class="text-gray-300">â†’</div>
                            </div>
                        </div>
                    </template>
                    
                    <div x-show="routines.length === 0" class="text-center py-10 text-gray-400 text-sm">
                        ç‚¹å‡»ä¸‹æ–¹ + å·åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªåœºæ™¯
                    </div>
                </div>

                <div x-show="activeTab === 'you'" x-cloak x-transition:enter="transition ease-out duration-200" class="p-5 space-y-6">
                    
                    <div class="bg-gray-800 text-white p-6 rounded-3xl shadow-lg relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="text-gray-400 text-xs font-bold uppercase mb-1">Total Sessions</div>
                            <div class="text-4xl font-bold mb-4" x-text="history.length"></div>
                            <div class="flex gap-4">
                                <div>
                                    <div class="text-gray-400 text-[10px] uppercase">Focus Time</div>
                                    <div class="font-bold text-lg"><span x-text="calculateTotalHistoryTime()"></span> min</div>
                                </div>
                            </div>
                        </div>
                        <div class="absolute right-0 bottom-0 w-32 h-32 bg-neuro rounded-full blur-3xl opacity-20 translate-y-10 translate-x-10"></div>
                    </div>

                    <div>
                        <div class="text-sm font-bold text-gray-800 mb-3 ml-1">Recent Activity</div>
                        <div class="space-y-3">
                            <template x-for="record in history" :key="record.id">
                                <div class="flex items-center justify-between bg-white p-4 rounded-2xl border border-gray-100 shadow-sm">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 rounded-full bg-neuro"></div>
                                        <span class="font-medium text-gray-700" x-text="record.title"></span>
                                    </div>
                                    <span class="text-xs text-gray-400 font-mono" x-text="record.time"></span>
                                </div>
                            </template>
                            <div x-show="history.length === 0" class="text-center py-8 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-200">
                                æš‚æ— ä¸“æ³¨è®°å½•<br>å» List é¡µé¢å¼€å§‹ä¸“æ³¨å§ï¼
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full bg-surface border-t border-gray-100 h-20 px-6 flex justify-between items-center z-50 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
                <button @click="activeTab = 'list'" class="nav-item flex flex-col items-center gap-1 w-16" :class="activeTab === 'list' ? 'active' : 'text-gray-400'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    <span class="text-[10px] font-bold">List</span>
                </button>
                
                <button @click="showNewRoutineForm = true" class="w-14 h-14 rounded-full bg-gradient-to-tr from-neuro-dark to-neuro text-white text-3xl shadow-lg shadow-teal-200/50 flex items-center justify-center active-press -mt-8 border-4 border-surface relative z-50">
                    +
                </button>

                <button @click="activeTab = 'you'" class="nav-item flex flex-col items-center gap-1 w-16" :class="activeTab === 'you' ? 'active' : 'text-gray-400'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <span class="text-[10px] font-bold">You</span>
                </button>
            </div>

            <div x-show="showNewRoutineForm" x-cloak class="absolute inset-0 bg-black/40 z-[60] flex items-center justify-center p-6 backdrop-blur-sm" @click.self="showNewRoutineForm = false">
                <div class="bg-surface w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-scale-up">
                    <h3 class="font-bold text-lg mb-4 text-gray-800">æ–°å»ºä¸“æ³¨åœºæ™¯</h3>
                    <input x-model="newRoutineTitle" type="text" placeholder="ç»™åœºæ™¯èµ·ä¸ªåå­—..." class="w-full bg-background p-4 rounded-xl mb-4 outline-none focus:ring-2 ring-neuro text-gray-800">
                    <div class="flex gap-3">
                        <button @click="showNewRoutineForm = false" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl">å–æ¶ˆ</button>
                        <button @click="createNewRoutine(); showNewRoutineForm = false" class="flex-1 bg-neuro text-white py-3 rounded-xl font-bold shadow-md">åˆ›å»º</button>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="view === 'detail'" x-cloak class="flex-1 flex flex-col h-full bg-surface z-40 absolute inset-0">
            <div class="pt-10 pb-2 px-4 flex items-center justify-between sticky top-0 bg-surface/95 backdrop-blur z-30 border-b border-gray-50">
                <button @click="view = 'dashboard'" class="text-gray-500 flex items-center gap-1 font-bold text-sm bg-gray-50 px-3 py-1.5 rounded-full">
                    â† Back
                </button>
                <div class="flex flex-col items-center">
                    <h2 class="font-bold text-lg text-gray-800" x-text="currentRoutine?.title"></h2>
                </div>
                <button @click="toggleEdit()" class="text-neuro font-bold text-sm px-2" x-text="isEditing ? 'å®Œæˆ' : 'ç¼–è¾‘'"></button>
            </div>

            <div class="px-5 py-3">
                <div class="bg-indigo-50/50 rounded-2xl p-4 border border-indigo-100">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2 text-indigo-900 font-bold text-sm">
                            <span class="animate-pulse">ğŸ§</span> ç™½å™ªéŸ³ (æ— éœ€è”ç½‘)
                        </div>
                        <span class="text-xs text-indigo-400 font-mono" x-text="selectedNoiseType || 'é™éŸ³'"></span>
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        <template x-for="noise in noiseOptions" :key="noise.type">
                            <button @click="selectNoise(noise.type)" 
                                    class="px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all border"
                                    :class="selectedNoiseType === noise.type ? 'bg-indigo-500 text-white border-indigo-500 shadow-md' : 'bg-white text-gray-500 border-gray-200'">
                                <span x-text="noise.icon"></span> <span x-text="noise.name"></span>
                            </button>
                        </template>
                        <button onclick="document.getElementById('music-upload').click()" class="px-4 py-2 bg-white text-gray-500 border border-gray-200 rounded-xl text-xs font-bold whitespace-nowrap">
                            ğŸ“‚ è‡ªå®šä¹‰
                        </button>
                        <input type="file" id="music-upload" accept="audio/*" class="hidden" @change="handleMusicUpload">
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto no-scrollbar px-5 pb-32 space-y-3 pt-2">
                <template x-for="(step, index) in currentRoutine?.steps" :key="step.id">
                    <div class="flex items-center gap-4 py-3 border-b border-gray-50 last:border-0 group">
                        <div class="w-10 h-10 rounded-full bg-white border-2 border-gray-100 flex-shrink-0 flex items-center justify-center text-lg shadow-sm" x-text="step.emoji"></div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-800 truncate text-base" x-text="step.text"></div>
                            <div class="text-xs text-gray-400" x-text="step.duration + ' min'"></div>
                        </div>
                        <button x-show="isEditing" @click="removeStep(index)" class="text-red-500 text-xs font-bold bg-red-50 px-3 py-1 rounded-full">åˆ é™¤</button>
                    </div>
                </template>

                <div x-show="isEditing" class="mt-4 p-4 bg-gray-50 rounded-3xl border border-gray-200">
                    <div class="flex gap-2 mb-2">
                        <input x-model="newStepText" placeholder="æ–°æ­¥éª¤åç§°" class="flex-1 px-4 py-3 rounded-xl border-none outline-none focus:ring-2 ring-neuro text-sm">
                        <input x-model="newStepEmoji" placeholder="Emoji" class="w-14 text-center rounded-xl border-none outline-none text-sm">
                    </div>
                    <div class="flex gap-2">
                        <input x-model="newStepDuration" type="number" placeholder="min" class="w-20 px-4 rounded-xl border-none outline-none text-sm">
                        <button @click="addStep()" class="flex-1 bg-neuro text-white rounded-xl text-sm font-bold">æ·»åŠ </button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-white via-white to-transparent z-30">
                <button @click="startFlow()" class="w-full bg-neuro hover:bg-neuro-dark text-white text-xl font-bold py-5 rounded-[1.5rem] shadow-xl shadow-teal-200/50 active-press transition-all">
                    ğŸš€ å¼€å§‹ä¸“æ³¨
                </button>
            </div>
        </div>

        <div x-show="view === 'focus'" x-cloak class="flex-1 flex flex-col h-full absolute inset-0 bg-surface z-50">
            <div class="pt-10 px-6 flex justify-between items-center">
                <button @click="exitFlow()" class="bg-gray-100 text-gray-500 px-3 py-1.5 rounded-full text-xs font-bold">âœ• é€€å‡º</button>
                <div x-show="selectedNoiseType" class="bg-indigo-50 text-indigo-500 px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-1">
                    <span class="animate-spin-slow">ğŸ”Š</span> <span x-text="selectedNoiseType"></span>
                </div>
            </div>

            <div class="flex-1 px-6 pt-6 pb-8 flex flex-col">
                <div class="bg-neuro w-full rounded-[2.5rem] p-8 text-white shadow-2xl shadow-teal-200/50 flex flex-col justify-between relative overflow-hidden min-h-[55%] mb-6">
                    <div class="flex justify-between items-start z-10">
                        <div>
                            <div class="text-teal-100 text-xs font-bold tracking-wider uppercase">CURRENT TASK</div>
                            <div class="text-white font-medium opacity-80"><span x-text="currentStep?.duration"></span> min total</div>
                        </div>
                        <div class="text-5xl animate-bounce drop-shadow-md" x-text="currentStep?.emoji"></div>
                    </div>
                    <div class="z-10 mt-4">
                        <div class="text-[5.5rem] font-mono-nums font-bold tracking-tighter leading-none mb-2 drop-shadow-sm" x-text="formatTime(timeLeft)">00:00</div>
                        <h2 class="text-3xl font-bold leading-tight" x-text="currentStep?.text"></h2>
                    </div>
                    <div class="w-full h-6 bg-black/20 rounded-full mt-auto z-10 overflow-hidden backdrop-blur-sm border border-white/10">
                        <div class="h-full bg-white shadow-[0_0_15px_rgba(255,255,255,0.5)] rounded-full progress-bar" :style="`width: ${calculateStepProgress()}%`"></div>
                    </div>
                    <div class="absolute -bottom-24 -right-24 w-80 h-80 bg-white/10 rounded-full blur-3xl pointer-events-none"></div>
                </div>

                <div class="mb-4 px-4">
                    <div class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-2 ml-1">Up Next</div>
                    <div class="flex items-center gap-4 bg-gray-50 p-3 rounded-2xl border border-gray-100">
                        <div class="w-8 h-8 rounded-full bg-white border border-gray-200 flex items-center justify-center text-sm" x-text="getNextStepEmoji()"></div>
                        <span class="text-gray-700 font-bold text-sm truncate" x-text="getNextStepText()"></span>
                    </div>
                </div>

                <div class="flex gap-3 mt-auto">
                    <button @click="resetTimer()" class="p-5 rounded-[1.5rem] bg-gray-100 text-gray-500 font-bold active-press">â†º</button>
                    <button @click="completeStep()" class="flex-1 bg-gray-900 text-white font-bold rounded-[1.5rem] text-xl shadow-xl active-press">
                        <span x-text="currentStepIndex === (currentRoutine?.steps.length - 1) ? 'ğŸ‰ å®Œæˆ' : 'ä¸‹ä¸€æ­¥ â†’'"></span>
                    </button>
                </div>
            </div>
        </div>

        <div x-show="view === 'summary'" x-cloak class="flex-1 flex flex-col items-center justify-center p-8 h-full absolute inset-0 bg-surface z-50 text-center">
            <div class="text-8xl mb-6 animate-bounce">ğŸŒŸ</div>
            <h2 class="text-4xl font-black text-gray-800 mb-2">Well Done!</h2>
            <p class="text-gray-500 mb-10 text-lg">ä½ å®Œæˆäº†æ­¤æ¬¡ä¸“æ³¨ã€‚</p>
            <button @click="resetToDashboard()" class="w-full bg-neuro text-white text-xl font-bold py-5 rounded-[1.5rem] shadow-xl active-press">è¿”å›ä¸»é¡µ</button>
        </div>

    </div>

    <audio id="custom-player" loop></audio>

    <script>
        function flowApp() {
            return {
                view: 'dashboard',
                activeTab: 'list', // 'list' | 'you'
                showNewRoutineForm: false,
                routines: [],
                history: [],
                currentRoutineIndex: 0,
                currentStepIndex: 0,
                timeLeft: 0,
                timer: null,
                isEditing: false,
                
                newRoutineTitle: '',
                newStepText: '', newStepEmoji: 'âœ¨', newStepDuration: 1,

                // ğŸ”Š å™ªå£°ç”Ÿæˆå™¨
                audioContext: null,
                noiseSource: null,
                gainNode: null,
                selectedNoiseType: '', // 'white', 'pink', 'brown', 'custom'
                noiseOptions: [
                    { name: 'é™éŸ³', icon: 'ğŸ”‡', type: '' },
                    { name: 'é›¨å£°', icon: 'ğŸŒ§ï¸', type: 'brown' },
                    { name: 'ç™½å™ª', icon: 'ğŸ“º', type: 'white' },
                    { name: 'ç²‰å™ª', icon: 'ğŸŒŠ', type: 'pink' }
                ],

                initApp() {
                    const savedData = localStorage.getItem('flowfocus_v6_data');
                    const savedHistory = localStorage.getItem('flowfocus_v6_history');
                    
                    if (savedData) {
                        this.routines = JSON.parse(savedData);
                    } else {
                        this.routines = [
                            {
                                id: 1, title: 'æ·±åº¦å­¦ä¹ ', emoji: 'ğŸ“š', 
                                steps: [
                                    { id: 101, text: 'æ‰‹æœºåæ‰£æ¡Œä¸Š', emoji: 'ğŸ“´', duration: 1 },
                                    { id: 102, text: 'æ·±å‘¼å¸', emoji: 'ğŸ§˜', duration: 1 },
                                    { id: 103, text: 'ä¸“æ³¨å·¥ä½œ', emoji: 'ğŸ’»', duration: 25 }
                                ]
                            }
                        ];
                    }
                    if (savedHistory) this.history = JSON.parse(savedHistory);
                },

                saveData() { localStorage.setItem('flowfocus_v6_data', JSON.stringify(this.routines)); },
                saveHistory() { localStorage.setItem('flowfocus_v6_history', JSON.stringify(this.history)); },
                clearHistory() { if(confirm('ç¡®å®šæ¸…ç©ºå†å²ï¼Ÿ')) { this.history = []; this.saveHistory(); } },

                // --- æ ¸å¿ƒéŸ³é¢‘ç”Ÿæˆé€»è¾‘ (Web Audio API) ---
                initAudioContext() {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                },

                selectNoise(type) {
                    this.selectedNoiseType = type;
                    // å¦‚æœæ­£åœ¨ä¸“æ³¨æ¨¡å¼ä¸‹åˆ‡æ¢ï¼Œç«‹å³ç”Ÿæ•ˆ
                    if (this.view === 'focus') {
                        this.stopNoise();
                        if (type) this.playNoise(type);
                    }
                },

                handleMusicUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.selectedNoiseType = 'custom';
                        const player = document.getElementById('custom-player');
                        player.src = URL.createObjectURL(file);
                        alert(`å·²åŠ è½½: ${file.name}`);
                    }
                },

                playNoise(type) {
                    this.initAudioContext();
                    
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰æ–‡ä»¶
                    if (type === 'custom') {
                        document.getElementById('custom-player').play();
                        return;
                    }

                    if (!type) return;

                    // åˆ›å»ºç™½å™ªéŸ³ Buffer
                    const bufferSize = 2 * this.audioContext.sampleRate;
                    const noiseBuffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
                    const output = noiseBuffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) {
                        // Pink Noise è¿‘ä¼¼ç®—æ³•
                        let white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = output[i];
                        output[i] *= 3.5; 
                    }
                    // ç®€å•çš„ç™½å™ªéŸ³ç”Ÿæˆ
                    if (type === 'white') {
                       for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
                    }

                    this.noiseSource = this.audioContext.createBufferSource();
                    this.noiseSource.buffer = noiseBuffer;
                    this.noiseSource.loop = true;
                    this.gainNode = this.audioContext.createGain();
                    
                    // æ»¤æ³¢å™¨æ¨¡æ‹Ÿé›¨å£° (Brown Noise)
                    if (type === 'brown' || type === 'pink') {
                        const filter = this.audioContext.createBiquadFilter();
                        filter.type = 'lowpass';
                        filter.frequency.value = type === 'brown' ? 400 : 1000;
                        this.noiseSource.connect(filter);
                        filter.connect(this.gainNode);
                    } else {
                        this.noiseSource.connect(this.gainNode);
                    }

                    this.gainNode.connect(this.audioContext.destination);
                    this.gainNode.gain.value = 0.05; // éŸ³é‡æ§åˆ¶
                    this.noiseSource.start();
                },

                stopNoise() {
                    if (this.noiseSource) {
                        this.noiseSource.stop();
                        this.noiseSource = null;
                    }
                    document.getElementById('custom-player').pause();
                },

                // --- ä¸šåŠ¡é€»è¾‘ ---
                openRoutine(index) { this.currentRoutineIndex = index; this.view = 'detail'; this.isEditing = false; },
                
                createNewRoutine() {
                    if(this.newRoutineTitle) {
                        this.routines.push({ id: Date.now(), title: this.newRoutineTitle, emoji: 'âœ¨', steps: [] });
                        this.newRoutineTitle = '';
                        this.saveData();
                    }
                },

                addStep() {
                    if(this.newStepText) {
                        this.routines[this.currentRoutineIndex].steps.push({
                            id: Date.now(), text: this.newStepText, emoji: this.newStepEmoji, duration: parseInt(this.newStepDuration)||1
                        });
                        this.newStepText = ''; this.saveData();
                    }
                },

                removeStep(idx) {
                    this.routines[this.currentRoutineIndex].steps.splice(idx, 1);
                    this.saveData();
                },

                startFlow() {
                    if(!this.currentRoutine?.steps?.length) return alert('è¯·æ·»åŠ æ­¥éª¤');
                    this.currentStepIndex = 0;
                    this.view = 'focus';
                    this.loadStepTimer();
                    this.playNoise(this.selectedNoiseType); // æ’­æ”¾ç”Ÿæˆå™ªéŸ³
                },

                loadStepTimer() {
                    clearInterval(this.timer);
                    this.timeLeft = this.currentStep.duration * 60;
                    this.timer = setInterval(() => {
                        if(this.timeLeft > 0) this.timeLeft--;
                        else clearInterval(this.timer);
                    }, 1000);
                },

                resetTimer() { this.timeLeft = this.currentStep.duration * 60; this.loadStepTimer(); },

                completeStep() {
                    if(this.currentStepIndex < this.currentRoutine.steps.length - 1) {
                        this.currentStepIndex++;
                        this.loadStepTimer();
                    } else {
                        this.finishFlow();
                    }
                },

                finishFlow() {
                    clearInterval(this.timer);
                    this.stopNoise();
                    this.view = 'summary';
                    
                    const now = new Date();
                    this.history.unshift({
                        id: Date.now(),
                        title: this.currentRoutine.title,
                        time: `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`
                    });
                    this.saveHistory();

                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 }, colors: ['#0d9488', '#fcd34d'] });
                },

                exitFlow() {
                    if(confirm('ç¡®å®šé€€å‡ºä¸“æ³¨ï¼Ÿ')) {
                        clearInterval(this.timer);
                        this.stopNoise();
                        this.view = 'detail';
                    }
                },

                resetToDashboard() { this.view = 'dashboard'; },
                toggleEdit() { this.isEditing = !this.isEditing; },

                // Helpers
                get currentRoutine() { return this.routines[this.currentRoutineIndex]; },
                get currentStep() { return this.currentRoutine?.steps?.[this.currentStepIndex]; },
                calculateTotalTime(r) { return r?.steps?.reduce((acc, curr) => acc + curr.duration, 0) || 0; },
                calculateTotalHistoryTime() { return this.history.length * 25; }, // ä¼°ç®—å€¼
                formatTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; },
                calculateStepProgress() {
                    if(!this.currentStep) return 0;
                    const total = this.currentStep.duration * 60;
                    return ((total - this.timeLeft) / total) * 100;
                },
                getNextStepEmoji() { return this.currentRoutine?.steps?.[this.currentStepIndex + 1]?.emoji || 'ğŸ'; },
                getNextStepText() { return this.currentRoutine?.steps?.[this.currentStepIndex + 1]?.text || 'All Done!'; }
            }
        }
        let lastOut = 0; // for pink noise
    </script>
    
    <style>
        .animate-scale-up { animation: scaleUp 0.3s ease-out; }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</body>
</html>